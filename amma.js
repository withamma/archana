// Generated by CoffeeScript 1.7.1
var app;

app = angular.module("linear-learning", ["ngRoute", "ngFitText", "ui.bootstrap", 'ngStorage']);

app.config(function($routeProvider) {
  return $routeProvider.when("/", {
    controller: "ItemListerCtrl",
    templateUrl: "item-lister.template"
  }).when("/memorize/:itemId", {
    controller: "MemorizeCtrl",
    templateUrl: "test.template"
  }).when("/results/:itemId", {
    controller: "ResultsCtrl",
    templateUrl: "results.template"
  }).otherwise({
    redirectTo: "/"
  });
});

app.controller("NavBarCtrl", [
  "$scope", function($scope) {
    return $scope.isCollapsed = true;
  }
]);

app.controller("ItemListerCtrl", [
  "$scope", "$http", function($scope, $http) {
    return $http.get("learning-items.json").success(function(data) {
      return $scope.items = data;
    });
  }
]);

app.controller("MemorizeCtrl", [
  "$scope", '$routeParams', '$http', "$location", '$localStorage', '$sce', function($scope, $routeParams, $http, $location, storage, $sce) {
    var id, incorrect, log, nextState;
    id = "" + $routeParams.itemId;
    $scope.state = "loading";
    if (storage[id] == null) {
      storage[id] = {};
      storage[id]["currentPosition"] = 0;
      storage[id]["log"] = {};
    }
    storage[id]["incorrect"] = [];
    $scope.currentPosition = storage[id]["currentPosition"];
    log = storage[id]["log"];
    incorrect = storage[id]["incorrect"];
    $http.get("learn/" + $routeParams.itemId + ".json").success(function(data) {
      $scope.listToLearn = data.list;
      $scope.title = data.title;
      return $scope.state = "show";
    });
    $scope.showAnswer = function() {
      return $scope.state = "answer";
    };
    nextState = function() {
      if ($scope.currentPosition + 2 < $scope.listToLearn.length) {
        $scope.currentPosition += 1;
        storage[id]["currentPosition"] = $scope.currentPosition;
        return $scope.state = "show";
      } else {
        $scope.state = "end";
        new Audio("sounds/victory_fanfare.mp3").play();
        return storage[id]["currentPosition"] = 0;
      }
    };
    $scope.submitAnswer = function(result) {
      if (result === "correct") {
        log[$scope.currentPosition] = {
          "correct": true
        };
      } else {
        log[$scope.currentPosition] = {
          "correct": false
        };
        incorrect.push({
          "previous": $scope.linkPrevious(),
          "next": $scope.linkTest()
        });
      }
      return nextState();
    };
    $scope.linkPrevious = function() {
      if ($scope.state !== "loading") {
        return $sce.trustAsHtml($scope.listToLearn[$scope.currentPosition]);
      } else {
        return $sce.trustAsHtml("Loading");
      }
    };
    $scope.linkTest = function() {
      if ($scope.state === "answer") {
        return $sce.trustAsHtml($scope.listToLearn[$scope.currentPosition + 1]);
      } else {
        return $sce.trustAsHtml("?");
      }
    };
    $scope.showResults = function() {
      return $location.path("results/" + id);
    };
    return $scope.restart = function() {
      storage[id] = {};
      storage[id]["currentPosition"] = 0;
      storage[id]["log"] = {};
      storage[id]["incorrect"] = [];
      $scope.currentPosition = storage[id]["currentPosition"];
      log = storage[id]["log"];
      incorrect = storage[id]["incorrect"];
      return $scope.state = "show";
    };
  }
]);

app.controller("ResultsCtrl", [
  "$scope", "$localStorage", '$routeParams', '$http', 'dateFilter', function($scope, storage, $routeParams, $http, dateFilter) {
    var id, today;
    id = "" + $routeParams.itemId;
    $scope.incorrect = storage[id]["incorrect"];
    $scope.exportQuizlet = function() {
      return $http.post("https://api.quizlet.com/2.0/sets", {
        "title": id + today(),
        "terms": $scope.incorrect.map(function(term) {
          return term.previous;
        }),
        "definitions": $scope.incorrect.map(function(term) {
          return term.next;
        }),
        "lang_terms": "en",
        "lang_definitions": "en",
        "allow_discussion": 0
      }).success(function(data) {
        return console.log(data);
      });
    };
    return today = function() {
      return dateFilter(new Date(), "MMM dd yyyy");
    };
  }
]);
